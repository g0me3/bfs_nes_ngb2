NEW BUGS

- пару раз случалось такое, что при определенной комбинации расположения героев и нажатых кнопках у катчера улетает ловушка и вешается нахрен сам скрипт ловушки. я не совсем уверен, что это именно мой баг, потому что кажется припоминают такой же глюк был как-то давно на оригинале. но проверить стоит.

FIXED

- как обычно косметические оптимизации, очистка мусора и ненужных кода и данных.
- где было можно, сокращены и оптимизированы на назмер скрипты.
- где было можно, опкоды с 16-битными оффсетами сконвертированы в опкоды с 8-битными (условные/безусловные переходы, загрузка/выгрузка и т.п.).
- исправлены некоторые не фатальные ошибки оригинальной игры, отмеченные в комментариях (двери второго уровня в вертикальных комнатах портят часть пола в предыдущей комнате, если вернуться назад, не выходя из комнаты после открывания дверей и т.п.).
- исправлены неправильно использованные тайлы титульного экрана, описанные ниже.
- неиспользованные тайловые карты и прочие данные и код исключены из билда, но оставлены в виде комментариев для возможного последующего использования.
- добавлен неиспользуемый музыкальный трек из европейской версии в звуковой тест под номером 13.
- в проект добавлены упаковщик/распаковщик тайловых карт для данной игры (обратно совместим с кирби, но менее эффективен. пакует идентично оригинальному пакеру без улучшений).
- звуковые данные и движок почищены от мусора и неиспользуемого кода/команд.
- оптимизированы по размеру звуковые команды DPCM семлов. экономит больше 300 байт звуковых данных. не так много, но кое-что.
- оптимизированы расчеты экранных координат в процессе работы скриптов. сейчас все экранные координаты считаются всего дважды - после отработки скрипта и после рисования спрайта (для обновления положения в соответствии с финальным изменением скроллов). все остальные процедуры теперь пользуют уже калькулированные значения. все это сократило объем кода и скорость его исполнения, хотя не очень сильно. там есть более толстые функции.
- более надежно поправил глюки спрайтов при перегрузке. в оригинальной игре была сделана попытка такого фикса, но они тупанули и засунули доп очистку вне цикла, так что для одного объекта очищался предварительно только первый тайл, а остальные оставались с мусором. причем ошибка эта осталась даже в европейке. теперь на экран не вылезают артефакты даже в самых суровых случаях.
- поддержка игры на двоих одновременно с одноигровым кодом. компилируется включенным, если TWO_PLAYER_MODE==1. может быть в принципе переключаем в реальном времени во время игры, но тогда кроме смены флага в переменной _two_player_mode_flag (0=1р, 1=2р), надо переинициализировывать два байта после _two_player_selections как 0 1 или 1 0 для выбора какой игрок будет кем играть. в одноигровом режиме второй байт не опрашивается и всегда инитится нулем. а еще переинициализировывать флаги управляющих кнопок.
	- управление общими контролсами (интро, меню, пауза, секретки) с обоих контроллеров независимо от текущего режима.
	- в режиме выбора игроков второй пад может выбрать своего игрока одновременно с первым.
	- первый пад, выбравший игрока, становится бимером.
	- второй пад, выбравший игрока, становится кэтчером.
	- в силу последовательности опроса, первый пад всегда имеет приоритет. два игрока не могут выбрать одного перса одновременно, но первее всегда будет первый.
	- привязка двух игроков друг к другу для предотвращения пропадания одного из них за экраном.
	- кетчер обладает всеми функциями бимера, кроме оружия: имеет отдельные жизни (отображаются на паузе) и может умереть, управляет скроллом экрана (но также не может оставлять бимера вне зоны видимости), открывает любые двери, включая пеерходы между уровнями.
- экспериментальная опция для разрешения активным объектам существовать за пределами экрана (компилировать с флагом OOS_ACTIVE==1). любой объект в комнате будет работать и вне поля зрения (летать кругами, например или убегать и прибегать из-за экрана). объекты, которые считают вектор на игрока в экранных координатах могут тупить, но это не будет заметно лол. к сожалению части некоторых объектов (например пули или оружие), которые имеют свою собственную проверку на предмет выхода за экран с последующим уничтожением, из-за экрана, естественно, появиться не смогут (например лизун, толкающий тележки в первом уровне, сделает это только попав в поле видимости. вернее он ее все равно толкнет, но она сразу самоуничтожится за экраном).
- исправлены два странных спрайта.
	- фаза лизуна, смотрящего вбок, имеет дырку подо ртом, как будто два нестыкующихся спрайта. но там просто в тайле нет нижней части пикселов. в спрайтах анимации титульного экрана есть копия этого лизуна, в которой боковые фазы не используются, но не содержат дырок внутри. если приглядеться, две фазы движения вбок там имеют разную высоту, лизун должен "подпрыгивать при ходьбе". тот спрайт, что имеет дырку внизу во время игры, в титуле опущен на пиксел вниз. получается, когда оптимизировали игровые тайлы спрайтов, выбросили лишние фазы и оставили лизуна в виде сбоку одной максимальной высоты, но тайл верхней части головы взяли от фазы меньшей высоты с титула. видимо ее просто сдвинули на пиксел вверх, иначе бы она не стыковалась макушкой с задней частью головы. а дырку зарисовать либо забыли, либо забили.
	- фаза "вертушки" из канализации, которая смотрит вправо-вниз имеет как раз-таки смещение нижнего правого тайла на 4 пиксела вправо. отсюда возникает небольшая черточка поодаль при кручении. это просто часть контура, не уместившаяся в 16 пикселей предыдущих двух спрайтов. а вместо координаты Х у этого спрайта стоит по какой-то причине $00 вместо $FD.
- изменен спрайтовый движок. формат спрайтов усложнился, что позволило сократить большую часть дублирующихся и повторных данных. старый движок выпилен.
- добавил отладчик спрайтов в основной код, места полно.

MISC

- музыкальный движок, спользованный в этой игре, идентичен использованному позже в игре Kirby от той же HAL Laboratory и многих других игр того же разработчика (GSX SUGA), например две поздние части Lolo и Uchubitai SDF. Музыкальные данные фактически могут быть перенесены из одной игры в другую, необходимо только подправлять библиотеку кодовых последовательностей (что-то вроде словаря) и DPCM семплы - они в играх разные.
- распаковщик тайловыйх карт является ранней версией распаковщика из кирби. в нем те же команды, но режим вычитки распакованных данных использует ппу как буфер распакованного, соответственно его вычитка и запись производятся через промежуточный буфер. у поздних версий распаковка происходит в отдельный предварительный буфер, где данные обновляются сразу и можно копировать очень длинные последовательности одной командой рекурсивно. в этой версии нельзя скопировать данных больше, чем было записано на текущий момент. так что ранний алгоритм упаковки разбивал такие последовательности на серию увеличивающихся блоков.
- дополнительно, все эти игры, за исключением Kirby, используют тот же самый скриптовой движок и могут быть дизассемблированы тем же способом и с применением тех же скриптов.
- принципиальные различия между региональными версиями заключаются в трех вещах: музыка, распределение врагов в комнатах и исправление некоторых багов.
	- музыку, судя по всему, поменяли для PAL версии исключительно для того, чтобы на 50Гц частоте она игралась идентично 60Гц обеих NTSC версий. при сравнении музыкальных данных видно, что последовательности нот остались идентичными, но поменялись длительности и тональности практически у всех участков. у обоих NTSC версий в коде музыки нет никаких отличий.
	- в отличие от NTSC версий, в которых имеется одинаковый неиспользуемый блок с копией данных семплов посреди данных музыки, в PAL версии в том же месте тоже сидит неиспользуемый кусок, который содержит целый законченный трек музыки. это полная версия зацикленного трека с катсцены с похищением младенца няней-призраком после третьего уровня. еще более интересно, что он играет в режиме NTSC.
	- в отличие от японской версии количество врагов в остальных региональных версиях уменьшено (как и укорочены последовательности врагов для открытия секретных мешочков). также некоторые враги заменены на более простых или изменено их начальное положение и задержки. кое-где были добавлены новые враги, но в целом все эти изменения уменьшили сложность. надо заметить, что это судя по всему, исходный вариант игры, на котором основана PAL версия и американский прототип, содержал как раз изначально уменьшенное число врагов. а для японской врагов добавили. это же потребовало дополнительно ввести в код скриптов уровней изменения банков графики при переходах на уровни, где были размещены новые виды врагов.
	- прототип американской версии не маскирует левый вертикальный ряд пикселов на экране, а также не прячет в этом столбце спрайты, как это сделано в японской и европейской версии. но это скорее всего недоделка разработчиков. без скрывания левого ряда тайлов видно, как работает клиппинг спрайтов в этом столбце. спрайты пропадают раньше, чем доходят до края экрана слева, иначе они неизбежно появились бы справа. собственно, такую функцию в PPU NES и ввели для этих целей, так как сама PPU аппаратно отсекать спрайты горизонтально не может.
	- американском прототипе есть баг со спрайтами, которые могут давать случайные глюки на экране при недоинициализированном клиппинге. в обоих релизных версиях этот баг попытались исправить, но сделали ошибку и при этом, так что исправили только частично. хотя во время основной игры это не везде заметно. это также является признаком того, что US версия - ранняя исходная версия игры, которую позже усложнили для японского релиза и на основе которой была сделана европейка.
	- только в европейской версии наконец исправили частичное появление спрайтов врагов, уходящих за левую сторону экрана, с его правой стороны. в обоих NTSC версиях вставка спрайтов обычных врагов происходит без какого-то ни было клиппинга.
	- американский прототип использует другой вид логотипа HAL радужного цвета. что характерно, этот логотип также отличается от аналогичных, использовавшихся в других американских релизах этой конторы. он слегка кривоват и имеет не совсем ровную "гребенку" слева.
	- остальные различия между версиями заключаются в текстах экрана лицензии и названия HAL на титульном экране. скрипты всех трех версий практически идентичны (за исключением указанного выше).
- на титульном экране у большого изображения привидения есть слабо видимые артефакты из-за неправильного использования некоторых тайлов, которе есть в графическом ПЗУ.
	- указательный палец на "виктори" в графическом ПЗУ расположен под буквами "ST" и имеет соответствующие полоски от самого нижнего ряда пикселе надписи. на титульном же экране надпись смещена вправо на 16 пикселей, так что палец приходится под букву "U". это привело к тому, что два тайла верхней части пальца не используются, а вместо них в ПЗУ добавлены два новых тайла с этим местом, но с нижней частью от буквы "U" соответственно.
	- во всех версиях логотипа начало указательного пальца копирует два тайла из его верхней части, делая палец цилиндрическим. в графическом ПЗУ есть два пропущенных неиспользуемых тайла для этой самостоятельной части пальца, которые делают его более естественным сужающимся.
	- во всех версиях логотипа также в ладони под большим пальцем пустое место, повторяющее тайл выше из большого пальца. оригинальный, предназначающийся туда тайл, пропущен и не используется.
	- исходная тайловая карта титульного экрана изображает привидение уже с прорывом посередине. отсутствие прорыва, как и его анимация, делаются через спрайтовый патч, наложенный сверху. часть бока справа, которая касается прорыва в оригинальном изображении, в версии для титульного экрана берет неверный тайл - на один ниже, чем требуется, отсюда сбоку у привидения цветной красный кусочек от кольца знака "стоп". у такого же изображения без прорыва, которое используется для концовки, с этим куском пуза все ок.
	- до кучи графика спрайтового патча для ноги без прорыва отличается от оригинального тайлом в ступне. у привидения с концовки на ноге небольшая складочка. у привидения на титуле ее нет.
- по поводу мешочков с деньгами. некоторые утверждают, что мешочки могут давать ни за что, без поимки привидений и все такое. вранье.
	- каждый мешочек - это такой объект, который является частью списка врагов каждой комнаты. он добавляется при входе в комнату и остается в ней, если не собран.
	- никак иначе мешочек в игру не добавляется.
	- выполнение условия поимки определенных сортов врагов в определенной последовательности обязательно для каждого мешочка - это часть его скрипта.
	- проверка последовательности пойманных врагов производится в процедуре подсчета очков за пойманное привидение.
	- есть один нюанс проверки последовательности. программа принимает только правильные значения. неправильные она просто игнорирует. т.е. для сбора нужной последовательности не требуется строго идти по списку. требуется из всех врагов в комнате заданное число нужных врагов собрать в заданной последовательности, но между ними могут быть собраны и прочие незначащие для мешочка враги. во многих комнатах число врагов больше, чем в списке. если вы убьете одного лишнего до или после начала сбора последовательности или нескольких посреди процесса сбора - ничего не изменится. последовательность будет собрана. проблема может быть только в одном, если собрать какого-то уникального врага между делом, для завершения последовательности его не останется. на этапе с шахтерами есть другая проблема. призраки на вагонетках через несколько итераций исчезают сами. почти везде они участвуют в призовой последовательности сбора. так что, чтобы получить мешочек на этом уровне, требуется торопиться.
	- некоторые комнаты можно посещать несколько раз, как например в первом уровне. для каждого такого посещения есть свой набор врагов для одной и той же комнаты, отличающийся между посещениями. скрипт инициализации конкретной отдельной комнаты же всегда один и применяется каждый раз при заходе в конкретную комнату независимо от последовательности. а так как список врагов для получения мешочка задается тоже в скрипте инициализации, он будет всегда одинаковым независимо от набора врагов. так что, если список призовых врагов в комнате не пустой, это не означает, что там есть мешочек. просто это список врагов от другой итерации этой комнаты, где мешочек был. и враги на уровнях подобраны таким образом, чтобы невозможно было повторно собрать заданную последовательность.
	- в графическом ПЗУ и в теле скрипта присутствуют остатки оставшегося неиспользованным объекта анимированной вращающейся монетки. либо это должен был быть мешочек, сыплющий монетками, либо он должен был замещаться на анимацию монетки... но в финальной версии в библиотеке спрайтов нет указателей на неиспользованный спрайтовый ресурс. видимо идея так и осталась на этапе планирования.
	- код AUEXKOAO позволяет увидеть все мешочки на всех уровнях, где они есть, сразу. возможно только может потребоваться пособирать некоотрых врагов, чтобы появились все остальные из списка для текущей комнаты. мешочек всегда идет последним.
- в упакованных ресурсах и в графическом ПЗУ сохранились данные для экрана с белыми кандзи на черном фоне. IAUAYEAA+AAUELELO чтобы заменить им экран с лого HAL.
- в банке с американским радужным логотипом HAL (есть во всех версиях без изменений) остаток неиспользуемой графики представляет из себя раннюю версию элементов экрана ввода пароля игры "лоло 2" (японская имеет номер 1). в данном банке тайлы расположены без оптимизации, естественным образом, и отсутствует ряд тайлов, появившихся в  оригинальной игре "лоло 2". например завитушки в нижней части рамки окна или оттененные кирпичи. надписи "лоло" и "лала" рядом с сердечком уже есть, однако сердечко тут нарисовано сложнее, чем в оригинале.
- в блоке графики для спрайтов титульного экрана и выбора игроков есть полный набор неоптимизированных тайлов для всех фаз анимации лизуна. причем их не две, а три. две с простым открыванием-закрыванием рта. одна - с выпученными глазами. на титуле используется только анфас версия открытия и закрытия рта. профиль версии не используются. забавно, что этот набор тайлов является основой для оптимизированного для ингейма лизуна. оптимизированная версия состоит всего из двух кадров анимации, у нее нет своей тени, она использует общую из банка графики игроков, а еще вторая фаза анимации с открытым ртом взята та, что в исходном виде с выпученными глазами. эта же фаза взята для анимации удержания лучом. т.е. получается, что на уровне лизун страшно выпучивает глаза при перемещении не потому, что так было задумано, а просто вторая простая фаза с открытым ртом при оптимизации была выброшена, а оставлена только та, что с выпученными глазами, которая и заюзана в двух разных фазах персонажа.
- в графике экрана паузы есть три квадратных иконки: пустая, с сапогами и с бронежилетом. судя по всему изначально планировались какие-то дополнительные повер-апы на скорость и защиту от хитов. данной функциональности в игре нет. еще остатками от этой же задумки, видимо являются тайлы в банке графики предпоследнего уровня для висящего на вешалке пиджака или как раз бронежилета.
- неиспользуемые тайлы на уровнях:
	- уровень 1, часть 1
		- тайл для небольшой лестницы (без центральной перемычки), лестница появляется только перед залом суда и расположена в другом банке.
		- тайлы для спрайтов бросаемых предметов: молоток, бутылка, окорок, книга, ролл, ключ, тапок, маленькие "ключики" двух видов (хз что это)
		- тайл большого симметричного шара, возможно увеличенная копия сегмента змеи в унитазе.
		- небольшой прожектайл в виде неровного камешка, похожено на прожектайлы привидений поезда, но другой.
		- одна фаза небольшого огонька, отличается от оконьков перед боссом вегой, огнем статуи свободы в концовке и огоньком, в который превращается прожектайл босса лизуна на поезде.
	- уровень 1, часть 2
		- две большие бумаги для одного из столов в суде (цвет фона аналогичен столу).
		- коробка, лежащая на части стола, расположенного диагонально. единственный элемент похожий по виду - это перевернутая тумба в коридоре на красном ковре, которая также используется и в первой части уровня.
		- небольшие часы
		- американский флаг на палке на черном фоне, соответственно он не подходит ни на один из элементов комнаты, только если снаружи за стеной здания.
	- уровень 2, часть 1
		- дополнительная третья фаза анимации открывания шлагбаума - самая длинная, расположенного боком к экрану. используются только две короткие фазы.
		- что-то вроде арки с колонной и стоп для рельсов в горизонтальной плоскости.
		- спрайт то ли замка, то ли куска трубы или свистка в обоих блоках графики для двух частей уровня.
	- уровень 3
		- альтернативная анимация открывания дверей. в релизной версии они просто разъезжаются, а в графике есть два кадра открывания ее внутрь.
		- тайлы для спрайта кровати - это либо какие-то остатки от катсцены с няней-призраком, либо возможно метательные предметы для неимплементенных врагов...
		- тайлы некоего уменьшающегося (или увеличивающегося) пятна. по палитре подходит под розовый.
	- уровень 4
		- набор тайлов предметов типа мусора: бутылка, ящик, доска, банка. каждый из них имеет две фазы анимации и как бы слегка подтерт снизу. очень похоже на то, что где-то изначально задумывалась комната с плавающим по воде мусором.
		- набор тайлов для некой кирпичной площадки более яркого цвета, чем использующиеся на всем уровне.
		- три блока тайлов аналогичной кирпичной площадки выше, но с постепенным затенением черными точками. это скорее всего спрайты, потому что присутствует всего один сектор из четырех, правда сетка нарисована прозрачным цветом. либо это какая-то анимация проявления площадки из под воды или анимация просто переливающейся воды по площадке под ней. назначение неизвестно.
	- уровень 5
		- объекты-спрайты: столбик, шахматная ладья. аналогичные предметы есть и в графике для тайлов уровня. эти предназначены либо для метания лизунами, либо просто чтобы они были разбросаны на полу для разнообразия.
- процедура для отправки в ППУ графических ресурсов _ppu_res_send_ex большая и универсальная. она сама определяет, в какой момент рендера приходят данные. если рендер включен, она выбирает заталкивание графики в очередь, если рендер выключен, сразу пишет в ППУ. в этой же процедуре есть вторая отдельная ветка кода для граф ресурсов вертикальной ориентации - у которых ширина меньше высоты. такие ресурсы оптимальнее записывать с вертикальным приращением адреса, что она и делает. эта ветка - полная копия основного цикла. но с вертикальным флагом. тем не менее эта ветка никогда в игре не используется. все ресурсы там горизонтальные.
- большая неиспользуемая ветка для специального режима данных есть и в процедуре вывода спрайтов. в данной игре она тоже не используется.
- во всех версиях игры присутствует оригинальный баг во втором уровне. если в вертикальном уровне открыть верхний шлагбаум, но не пройти дальше, а вернуться, то можно заметить попорченный тайл у начала второй половины комнаты. это происходит из-за ошибки в процедуре рисования закрытой двери. вместо 2 мета тайлов она рисует четыре, два из которых приходятся на те два кривых тайла. если бежать всегда вперед, то этого бага можно и не заметить...
- не знаю, как вы, а я только догадался, почему некоторые двери на третьем уровне динькают! ни в одном больше другом уровне такого нет. думал, какие-то остатки от попытки сообщать, что в комнате есть мешочки. но динькает и там, где их нет. в общем, это звук закрытия ЛИФТА. ведь этот уровень не зря такой длинный и однотипный. бастерсы поднимаются по этажам на крышу. каждый диньк - новый этаж здания.
- исходный движок имеет одну небольшую особенность в плане работы со спрайтами. для скорости спрайты пишутся на лету и в конце цикла финишируются. если нагрузка больше требуемой, прерывание приходит в процессе работы и может совпасть с моментом генерации спрайтов. в любом случае оно перешлет спрайтовый буфер в ппу по дма, даже если он не готов и не финиширован. от этого случаются изредка появляющиеся всего на кадр косяки. в оригинале эти косяки минимизированы подбором числа врагов на уровне ну и вообще оттвикано, чтобы случаться реже.
- анимация вращения игрока после получения хита имеет 30 кадров. каждый кадр персонаж крутится на 90 градусов. соответственно, к последнему кадру игрок оказывается повернут ровно на 180 градусов от своего исходного положения. для того, чтобы после хита игрок восстанавливался лицом в том же направлении, как умер, анимация должна занимать 32 или 28 кадров для целого числа оборотов.
- в последней части первого уровня меняется вид дверей и их открытый вид - их пол серый. входная дверь уровня, тем не менее, расположена на красном полу, но используется та же самая дверь с белым полом. по прошествии столького времени только вот сейчас заметил как это выглядит криво.

TODO

- что можно сделать нового в игре.
	- добавить новые бонусы типа ботинок и бронежилета. сделать соответственное отображение собранных предметов на экране паузы
	- задействовать звездочки для отображения рейтинга прохождения либо сложности, либо числа собранных/оставшихся врагов на уровне. хз для чего они предназначались, но их можно приспособить для чего угодно
	- расширить число игровых элементов, изменяемых параметром сложности. в текущей версии только число жизней и очки для получения очередной жизни меняются с изменением сложности. можно сделать списки врагов динамическими для каждой сложности, выводить больше врагов на экран одновременно.
	- каким-то образом сделать разницу между разными персонажами, выбираемыми для игры. сейчас разница только во внешнем виде. почему бы не дать им какие-то специальные характеристики, меняющие механику игры за такого персонажа. скорость, число жизней, длина луча, длина ловушки, тупизна и тп... естественно тут потребуется придумать какую-то систему балансировки. чтобы не получислось случая, когда выбираешь самое крутое сочетание персонажей, которое рвет все остальные варианты.
	- меню выбора уровней